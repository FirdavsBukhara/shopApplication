<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ú–æ—è –∫–æ—Ä–∑–∏–Ω–∞</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            background-color: #fafafa;
        }
        h2 { color: #333; }
        .logout { float: right; color: red; cursor: pointer; }
        .cart-item {
            border: 1px solid #ddd;
            background: white;
            padding: 15px;
            margin: 10px;
            border-radius: 8px;
            width: 300px;
            display: inline-block;
            vertical-align: top;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .cart-item img {
            max-width: 100%;
            border-radius: 6px;
        }
        .cart-controls {
            margin-top: 10px;
        }
        button {
            border: none;
            border-radius: 5px;
            padding: 6px 10px;
            cursor: pointer;
            margin: 5px 3px;
        }
        button.remove-btn { background-color: #ff4444; color: white; }
        button.remove-btn:hover { background-color: #dd0000; }
        button.clear-btn { background-color: #888; color: white; }
        button.clear-btn:hover { background-color: #666; }
        button.order-btn { background-color: #4CAF50; color: white; }
        button.order-btn:hover { background-color: #45a049; }
        button.back-btn { background-color: #007bff; color: white; }
        button.back-btn:hover { background-color: #0069d9; }
        .price { font-weight: bold; color: #2e8b57; }
    </style>
</head>
<body>

<h2>üõí –ú–æ—è –∫–æ—Ä–∑–∏–Ω–∞</h2>
<span class="logout" onclick="logout()">–í—ã–π—Ç–∏</span>

<div id="cartItems"></div>

<div style="margin-top: 20px;">
    <button class="clear-btn" onclick="clearCart()">üßπ –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É</button>
    <button class="order-btn" onclick="makeOrder()">üí∞ –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
    <button class="back-btn" onclick="goBack()">‚Üê –ù–∞–∑–∞–¥ –∫ —Ç–æ–≤–∞—Ä–∞–º</button>
</div>

<script>
    const API_URL = "http://localhost:8080/api/cart";

    function getToken() {
        return localStorage.getItem("token");
    }

    async function authFetch(url, options = {}) {
        const token = getToken();
        const headers = {
            ...(options.headers || {}),
            "Authorization": `Bearer ${token}`,
        };
        if (!(options.body instanceof FormData)) {
            headers["Content-Type"] = "application/json";
        }
        const response = await fetch(url, { ...options, headers });
        if (response.status === 401) {
            alert("–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –í–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.");
            localStorage.removeItem("token");
            window.location.href = "/login.html";
            return null;
        }
        return await response.json();
    }

    async function loadCart() {
        const cartDiv = document.getElementById("cartItems");
        const data = await authFetch(API_URL);
        if (!data || !data.items || data.items.length === 0) {
            cartDiv.innerHTML = "<p>–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.</p>";
            return;
        }

        cartDiv.innerHTML = "";
        let total = 0;

        data.items.forEach(item => {
            const price = parseFloat(item.price).toFixed(2);
            const sum = (item.quantity * price).toFixed(2);
            total += parseFloat(sum);

            const div = document.createElement("div");
            div.className = "cart-item";
            div.innerHTML = `
                <strong>${item.productName}</strong><br>
                –¶–µ–Ω–∞: <span class="price">${price} USD</span><br>
                –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${item.quantity}<br>
                –°—É–º–º–∞: <span class="price">${sum} USD</span><br>
                <div class="cart-controls">
                    <button class="remove-btn" onclick="removeItem(${item.id})">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            `;
            cartDiv.appendChild(div);
        });

        const totalDiv = document.createElement("div");
        totalDiv.innerHTML = `<h3>–ò—Ç–æ–≥–æ: ${total.toLocaleString("ru-RU", { minimumFractionDigits: 2 })} USD</h3>`;
        cartDiv.appendChild(totalDiv);
    }

    async function removeItem(productId) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã?")) return;
        await fetch(`${API_URL}/remove/${productId}`, {
            method: "DELETE",
            headers: { "Authorization": "Bearer " + getToken() }
        });
        loadCart();
    }

    async function clearCart() {
        if (!confirm("–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É?")) return;
        await fetch(`${API_URL}/clear`, {
            method: "DELETE",
            headers: { "Authorization": "Bearer " + getToken() }
        });
        loadCart();
    }

    function makeOrder() {
        alert("üßæ –ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω! (—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –¥–æ–±–∞–≤–∏–º –ø–æ–∑–∂–µ)");
    }

    function goBack() {
        window.location.href = "/products.html";
    }

    function logout() {
        localStorage.removeItem("token");
        window.location.href = "/login.html";
    }
    loadCart();
</script>
</body>
</html>