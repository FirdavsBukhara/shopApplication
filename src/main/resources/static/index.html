<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ì–ª–∞–≤–Ω–∞—è</title>
</head>
<body>
<h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
<p id="welcome"></p>
<button onclick="logout()">–í—ã–π—Ç–∏</button>

<hr>

<h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>

<!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
<div>
    <input type="text" id="newCategoryName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏">
    <button onclick="addCategory()">–î–æ–±–∞–≤–∏—Ç—å</button>
</div>

<br>
<div id="categoryList"></div>

<script>
    const token = localStorage.getItem("token");
    const username = localStorage.getItem("username");

    if (!token) {
        window.location.href = "/login.html";
    }

    document.getElementById("welcome").textContent = "–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: " + username;

    async function loadCategories() {
        const response = await fetch("http://localhost:8080/api/categories", {
            headers: {
                "Authorization": "Bearer " + token
            }
        });

        if (!response.ok) {
            alert("–û—à–∏–±–∫–∞: " + response.status);
            if (response.status === 401) {
                window.location.href = "/login.html";
            }
            return;
        }

        const categories = await response.json();
        const container = document.getElementById("categoryList");
        container.innerHTML = "";

        categories.forEach(cat => {
            const div = document.createElement("div");
            div.style.margin = "8px 0";

            const btn = document.createElement("button");
            btn.textContent = cat.name;
            btn.onclick = () => {
                window.location.href = `/products.html?categoryId=${cat.id}`;
            };

            const editBtn = document.createElement("button");
            editBtn.textContent = "‚úèÔ∏è";
            editBtn.style.marginLeft = "10px";
            editBtn.onclick = () => editCategory(cat.id, cat.name);

            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "üóëÔ∏è";
            deleteBtn.style.marginLeft = "5px";
            deleteBtn.onclick = () => deleteCategory(cat.id);

            div.appendChild(btn);
            div.appendChild(editBtn);
            div.appendChild(deleteBtn);

            container.appendChild(div);
        });
    }

    async function addCategory() {
        const name = document.getElementById("newCategoryName").value.trim();
        if (!name) {
            alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏");
            return;
        }

        const response = await fetch("http://localhost:8080/api/categories", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            },
            body: JSON.stringify({ name })
        });

        if (response.ok) {
            document.getElementById("newCategoryName").value = "";
            loadCategories();
        } else {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: " + response.status);
        }
    }

    async function editCategory(id, oldName) {
        const newName = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:", oldName);
        if (!newName || newName.trim() === "" || newName === oldName) return;

        const response = await fetch(`http://localhost:8080/api/categories/${id}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            },
            body: JSON.stringify({ name: newName })
        });

        if (response.ok) {
            loadCategories();
        } else {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: " + response.status);
        }
    }

    async function deleteCategory(id) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é?")) return;

        const response = await fetch(`http://localhost:8080/api/categories/${id}`, {
            method: "DELETE",
            headers: {
                "Authorization": "Bearer " + token
            }
        });

        if (response.ok) {
            loadCategories();
        } else {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: " + response.status);
        }
    }

    function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("username");
        window.location.href = "/login.html";
    }

    loadCategories();
</script>

</body>
</html>
