<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–¢–æ–≤–∞—Ä—ã</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        h2 { color: #333; }
        .logout { float: right; color: red; cursor: pointer; }
        .category-list { margin-bottom: 20px; }
        .category-list button {
            margin-right: 10px;
            padding: 5px 10px;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            border-radius: 5px;
            cursor: pointer;
        }
        .category-list button:hover { background-color: #ddd; }
        .product {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px;
            border-radius: 8px;
            width: 250px;
            display: inline-block;
            vertical-align: top;
        }
        .product img {
            max-width: 100%;
            border-radius: 6px;
            margin-top: 5px;
        }
        .add-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .add-btn:hover { background-color: #45a049; }
        button.edit-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 6px 10px;
            cursor: pointer;
            border-radius: 5px;
            margin-top: 8px;
        }
        button.edit-btn:hover { background-color: #0069d9; }
    </style>
</head>
<body>

<h2>–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤</h2>
<span class="logout" onclick="logout()">–í—ã–π—Ç–∏</span>

<div class="category-list" id="categoryList"></div>
<div id="adminControls" style="margin: 15px 0;"></div>
<div id="products"></div>

<script>
    function getToken() {
        return localStorage.getItem("token");
    }

    async function authFetch(url, options = {}) {
        const token = getToken();
        const headers = {
            ...(options.headers || {}),
            "Authorization": `Bearer ${token}`,
        };
        if (!(options.body instanceof FormData)) {
            headers["Content-Type"] = "application/json";
        }

        const response = await fetch(url, { ...options, headers });
        if (response.status === 401) {
            alert("–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –í–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.");
            localStorage.removeItem("token");
            window.location.href = "/login.html";
            return null;
        }
        try {
            return await response.json();
        } catch {
            return response;
        }
    }

    const token = getToken();
    if (!token) {
        alert("–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã!");
        window.location.href = "/login.html";
    }

    async function getUserRole() {
        const user = await authFetch("http://localhost:8080/auth/me");
        return user?.role || "USER";
    }

    async function loadCategories() {
        const categories = await authFetch("http://localhost:8080/api/categories");
        const container = document.getElementById("categoryList");
        container.innerHTML = "";

        categories.forEach(cat => {
            const btn = document.createElement("button");
            btn.textContent = cat.name;
            btn.onclick = () => loadProducts(cat.id);
            container.appendChild(btn);
        });
    }

    async function loadProducts(categoryId = null) {
        const role = await getUserRole();
        const productsDiv = document.getElementById("products");
        productsDiv.innerHTML = "";

        let url = "http://localhost:8080/api/products";
        if (categoryId) url = `http://localhost:8080/api/products/category/${categoryId}`;

        const products = await authFetch(url);
        if (!products || products.length === 0) {
            productsDiv.innerHTML = "<p>–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.</p>";
            showAdminControls(categoryId, role);
            return;
        }

        showAdminControls(categoryId, role);

        products.forEach(p => {
            const div = document.createElement("div");
            div.className = "product";
            div.innerHTML = `
                <strong>${p.name}</strong><br>
                ${p.description || ""}<br>
                üí≤ ${p.price}<br>
                ${p.imageUrl ? `<img src="${p.imageUrl}" alt="${p.name}">` : ""}
                ${role === "ADMIN" ? `
                    <br><button class="edit-btn" onclick="editProduct(${p.id})">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
                    <button class="delete-btn" onclick="deleteProduct(${p.id})">üóë –£–¥–∞–ª–∏—Ç—å</button>
                    <button class="pdf-btn" onclick="downloadPdf(${p.id})">üìÑ –°–∫–∞—á–∞—Ç—å PDF</button>
                ` : ""}
            `;
            productsDiv.appendChild(div);
        });
    }

    async function showAdminControls(categoryId, role) {
        const controls = document.getElementById("adminControls");
        controls.innerHTML = "";

        if (role === "ADMIN") {
            // –ö–Ω–æ–ø–∫–∞ "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏"
            const usersBtn = document.createElement("button");
            usersBtn.className = "add-btn";
            usersBtn.textContent = "üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏";
            usersBtn.onclick = () => window.location.href = "/users.html";
            controls.appendChild(usersBtn);
        }

        if (role === "ADMIN" && categoryId) {
            const btn = document.createElement("button");
            btn.className = "add-btn";
            btn.textContent = "‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä";
            btn.onclick = () => addProduct(categoryId);
            controls.appendChild(btn);
        }
    }
    function downloadPdf(id) {
        const token = localStorage.getItem("token");
        fetch(`http://localhost:8080/api/products/${id}/pdf`, {
            method: "GET",
            headers: { "Authorization": "Bearer " + token }
        })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `product_${id}.pdf`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            })
            .catch(() => alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ PDF"));
    }

    function addProduct(categoryId) {
        window.location.href = `/addProduct.html?categoryId=${categoryId}`;
    }

    function editProduct(id) {
        window.location.href = `/editProduct.html?productId=${id}`;
    }

    function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("username");
        window.location.href = "/login.html";
    }

    loadCategories();
    async function deleteProduct(id) {
        if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä?")) return;

        const response = await fetch(`http://localhost:8080/api/products/${id}`, {
            method: "DELETE",
            headers: { "Authorization": "Bearer " + token }
        });

        if (response.ok) {
            alert("‚úÖ –¢–æ–≤–∞—Ä —É–¥–∞–ª—ë–Ω!");
            loadProducts();
        } else {
            alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞");
        }
    }
</script>

</body>
</html>
