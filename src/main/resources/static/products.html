<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–¢–æ–≤–∞—Ä—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        h2 { color: #333; }
        .product {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .product img {
            max-width: 150px;
            display: block;
            margin-top: 10px;
        }
        .back { text-decoration: none; color: #007bff; }
        .logout { float: right; color: red; cursor: pointer; }
        .add-btn {
            background-color: #4CAF50; color: white;
            border: none; padding: 10px 15px;
            border-radius: 5px; cursor: pointer;
            margin-bottom: 15px;
        }
        .add-btn:hover { background-color: #45a049; }
    </style>
</head>
<body>

<h2 id="categoryName">–¢–æ–≤–∞—Ä—ã</h2>
<a href="index.html" class="back">‚Üê –ù–∞–∑–∞–¥ –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</a>
<span class="logout" onclick="logout()">–í—ã–π—Ç–∏</span>

<div id="adminControls" style="margin-top: 20px;"></div>
<div id="products"></div>

<script>
    const token = localStorage.getItem("token");
    if (!token) {
        alert("–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã!");
        window.location.href = "/login.html";
    }

    const params = new URLSearchParams(window.location.search);
    const categoryId = params.get("categoryId");
    const categoryName = params.get("categoryName");

    if (!categoryId) {
        alert("–ù–µ –≤—ã–±—Ä–∞–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è!");
        window.location.href = "/index.html";
    }

    document.getElementById("categoryName").textContent =
        "–ö–∞—Ç–µ–≥–æ—Ä–∏—è: " + (categoryName || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è");

    async function getUserRole() {
        // üîπ –Ω–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –Ω–∞ –±—ç–∫–µ /auth/me –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const res = await fetch("http://localhost:8080/auth/me", {
            headers: { "Authorization": "Bearer " + token }
        });
        if (!res.ok) return null;
        const user = await res.json();
        return user.role || null;
    }

    async function loadProducts() {
        const response = await fetch(`http://localhost:8080/api/products/category/${categoryId}`, {
            headers: { "Authorization": "Bearer " + token }
        });

        if (response.status === 401) {
            alert("–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –í–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.");
            window.location.href = "/login.html";
            return;
        }

        const productsDiv = document.getElementById("products");
        productsDiv.innerHTML = "";

        if (!response.ok) {
            productsDiv.textContent = "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–æ–≤–∞—Ä–æ–≤.";
            return;
        }

        const products = await response.json();
        if (products.length === 0) {
            productsDiv.textContent = "–í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤.";
            return;
        }

        products.forEach(p => {
            const div = document.createElement("div");
            div.className = "product";
            div.innerHTML = `
          <strong>${p.name}</strong><br>
          ${p.description || ""}<br>
          üí≤ ${p.price}<br>
          ${p.imageUrl ? `<img src="${p.imageUrl}" alt="${p.name}">` : ""}
        `;
            productsDiv.appendChild(div);
        });
    }

    async function showAdminControls() {
        const role = await getUserRole();
        if (role && role === "ADMIN") {
            const controls = document.getElementById("adminControls");
            const btn = document.createElement("button");
            btn.className = "add-btn";
            btn.textContent = "‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä";
            btn.onclick = () => {
                window.location.href = `/addProduct.html?categoryId=${categoryId}`;
            };
            controls.appendChild(btn);
        }
    }

    function logout() {
        localStorage.removeItem("token");
        window.location.href = "/login.html";
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadProducts();
    showAdminControls();
</script>

</body>
</html>
